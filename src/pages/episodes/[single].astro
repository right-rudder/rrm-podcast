---
import Base from "@/layouts/Base.astro";
import Schema from "@/layouts/components/Schema.astro";
import PostSingle from "@/layouts/PostSingle.astro";
import { getSinglePage } from "@/lib/contentParser.astro";
import {
  getPodcastEpisodeSchema,
  getBreadcrumbSchema,
  combineSchemas,
} from "@/lib/schema";
import { getEpisodeCanonical } from "@/lib/canonical";
import config from "@/config/config.json";

export async function getStaticPaths() {
  const EPISODES_FOLDER = "episodes";
  const episodes = await getSinglePage(EPISODES_FOLDER);

  const paths = episodes.map((episode) => ({
    params: {
      single: episode.id,
    },
    props: { post: episode },
  }));
  return paths;
}

const { post } = Astro.props;
const { title, meta_title, description, image } = post.data;

// Generate canonical URL for this episode
const canonical = getEpisodeCanonical(post.id);

// Generate episode schema
const episodeSchema = getPodcastEpisodeSchema(post);

// Generate breadcrumb schema
const breadcrumbs = [
  { name: "Home", url: config.site.base_url },
  { name: "Episodes", url: `${config.site.base_url}/episodes` },
  { name: title, url: `${config.site.base_url}/episodes/${post.id}` },
];
const breadcrumbSchema = getBreadcrumbSchema(breadcrumbs);

const schemas = combineSchemas([episodeSchema, breadcrumbSchema]);
---

<Base
  title={title}
  meta_title={meta_title}
  description={description}
  image={image}
  canonical={canonical}
>
  <Schema schema={schemas} />
  <PostSingle post={post} />
</Base>
